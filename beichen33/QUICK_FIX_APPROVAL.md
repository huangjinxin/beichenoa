# å®¡æ‰¹äººé€‰æ‹©å™¨èŒä½ä¿¡æ¯æ˜¾ç¤º - å¿«é€Ÿè§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°
åœ¨å®¡æ‰¹æµç¨‹è®¾è®¡å™¨ä¸­é€‰æ‹©å®¡æ‰¹äººæ—¶ï¼Œæ²¡æœ‰æ˜¾ç¤ºæ•™å¸ˆçš„èŒä½ä¿¡æ¯ã€‚

## å¯èƒ½çš„åŸå› 

1. **æ•°æ®åº“ä¸­æ²¡æœ‰èŒä½æ•°æ®**
2. **ç”¨æˆ·(æ•™å¸ˆ)æ²¡æœ‰å…³è”èŒä½**
3. **API è¯·æ±‚å¤±è´¥**
4. **å‰ç«¯æœªæ­£ç¡®åŠ è½½æ•°æ®**

## å¿«é€Ÿæ£€æŸ¥æ­¥éª¤

### 1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æ—¥å¿—

1. æŒ‰ F12 æ‰“å¼€ Chrome DevTools
2. åˆ‡æ¢åˆ° **Console** æ ‡ç­¾
3. åœ¨å®¡æ‰¹æµç¨‹è®¾è®¡å™¨é¡µé¢ç‚¹å‡»"æ·»åŠ å®¡æ‰¹èŠ‚ç‚¹"
4. æŸ¥çœ‹æ˜¯å¦æœ‰ä»¥ä¸‹è¾“å‡ºï¼š

```
å®¡æ‰¹äººé€‰é¡¹: [...]
è§’è‰²é€‰é¡¹: [...]
èŒä½é€‰é¡¹: [...]
```

å¦‚æœçœ‹åˆ° `å®¡æ‰¹äººé€‰é¡¹: []` (ç©ºæ•°ç»„)ï¼Œè¯´æ˜æ²¡æœ‰åŠ è½½åˆ°å®¡æ‰¹äººæ•°æ®ã€‚

### 2. æ£€æŸ¥ Network è¯·æ±‚

1. åˆ‡æ¢åˆ° **Network** æ ‡ç­¾
2. ç­›é€‰ `approvers`
3. æŸ¥çœ‹ `/api/approvals/approvers` è¯·æ±‚ï¼š
   - **çŠ¶æ€ç  200**: API æ­£å¸¸ï¼Œæ£€æŸ¥è¿”å›æ•°æ®
   - **çŠ¶æ€ç  401**: Token è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•
   - **çŠ¶æ€ç  404**: åç«¯æœåŠ¡é—®é¢˜ï¼Œéœ€è¦é‡å¯åç«¯

### 3. æ£€æŸ¥è¿”å›çš„æ•°æ®ç»“æ„

åœ¨ Network æ ‡ç­¾ä¸­ï¼Œç‚¹å‡» `/api/approvals/approvers` è¯·æ±‚ï¼ŒæŸ¥çœ‹ **Response** æ ‡ç­¾ï¼š

**æ­£ç¡®çš„æ•°æ®æ ¼å¼**:
```json
[
  {
    "userId": "xxx",
    "userName": "å¼ ä¸‰",
    "email": "zhangsan@example.com",
    "role": "TEACHER",
    "position": "å›­é•¿",          // â† åº”è¯¥æœ‰è¿™ä¸ªå­—æ®µ
    "positionType": "PRINCIPAL"  // â† åº”è¯¥æœ‰è¿™ä¸ªå­—æ®µ
  }
]
```

**å¦‚æœ position ä¸º null**:
```json
[
  {
    "userId": "xxx",
    "userName": "å¼ ä¸‰",
    "email": "zhangsan@example.com",
    "role": "TEACHER",
    "position": null,           // â† ç”¨æˆ·æ²¡æœ‰å…³è”èŒä½
    "positionType": null
  }
]
```

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä¸ºç”¨æˆ·åˆ†é…èŒä½ï¼ˆæ¨èï¼‰

#### æ­¥éª¤ 1: åˆ›å»ºèŒä½ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

1. è¿›å…¥ç³»ç»Ÿçš„ **èŒä½ç®¡ç†** é¡µé¢ (é€šå¸¸åœ¨ç³»ç»Ÿè®¾ç½®ä¸­)
2. ç‚¹å‡»"æ·»åŠ èŒä½"
3. åˆ›å»ºä»¥ä¸‹èŒä½ï¼š
   - å›­é•¿ (PRINCIPAL, å±‚çº§ 1)
   - å‰¯å›­é•¿ (VICE_PRINCIPAL, å±‚çº§ 2)
   - ä¸»ä»» (DIRECTOR, å±‚çº§ 3)
   - æ•™å¸ˆ (TEACHER, å±‚çº§ 4)

#### æ­¥éª¤ 2: ä¸ºæ•™å¸ˆåˆ†é…èŒä½

1. è¿›å…¥ **æ•™å¸ˆç®¡ç†** é¡µé¢
2. æ‰¾åˆ°éœ€è¦è®¾ç½®çš„æ•™å¸ˆ
3. ç‚¹å‡»"ç¼–è¾‘"
4. åœ¨èŒä½ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹©å¯¹åº”çš„èŒä½
5. ä¿å­˜

#### æ­¥éª¤ 3: éªŒè¯

1. åˆ·æ–°å®¡æ‰¹æµç¨‹è®¾è®¡å™¨é¡µé¢
2. é‡æ–°æ‰“å¼€"æ·»åŠ å®¡æ‰¹èŠ‚ç‚¹"
3. é€‰æ‹©"æŒ‡å®šç”¨æˆ·"
4. ç°åœ¨åº”è¯¥èƒ½çœ‹åˆ°æ•™å¸ˆåé¢æœ‰èŒä½æ ‡ç­¾äº†

### æ–¹æ¡ˆ B: ä½¿ç”¨æµ‹è¯•è„šæœ¬éªŒè¯

```bash
# 1. ç™»å½•ç³»ç»Ÿè·å– Token
# åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ: localStorage.getItem('token')

# 2. è¿è¡Œæµ‹è¯•è„šæœ¬
./test-approvers-api.sh YOUR_TOKEN

# 3. æŸ¥çœ‹è¾“å‡ºï¼Œæ ¹æ®æç¤ºè§£å†³é—®é¢˜
```

### æ–¹æ¡ˆ C: ç›´æ¥é€šè¿‡ API åˆ›å»ºèŒä½å’Œåˆ†é…

å¦‚æœç³»ç»Ÿæ²¡æœ‰èŒä½ç®¡ç† UIï¼Œå¯ä»¥é€šè¿‡ API ç›´æ¥æ“ä½œï¼š

```bash
# è·å– Token (åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ)
# localStorage.getItem('token')

export TOKEN="ä½ çš„token"

# åˆ›å»ºèŒä½
curl -X POST http://localhost:3000/api/positions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "name": "å›­é•¿",
    "type": "PRINCIPAL",
    "level": 1
  }'

# å‡è®¾è¿”å›çš„ ID æ˜¯ position-id-123

# æ›´æ–°ç”¨æˆ·èŒä½
curl -X PUT http://localhost:3000/api/users/user-id-456 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "positionId": "position-id-123"
  }'
```

## éªŒè¯æˆåŠŸçš„æ ‡å¿—

å®¡æ‰¹äººé€‰æ‹©å™¨åº”è¯¥æ˜¾ç¤ºå¦‚ä¸‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é€‰æ‹©å®¡æ‰¹äºº                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” è¯·é€‰æ‹©å®¡æ‰¹äººï¼ˆå¯æŒ‰å§“åæˆ–èŒä½æœç´¢ï¼‰    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â˜‘ å¼ ä¸‰  [å›­é•¿]  [TEACHER]  zhang@...   â”‚
â”‚ â˜ æå››  [ä¸»ä»»]  [TEACHER]  li@...      â”‚
â”‚ â˜ ç‹äº”  [æ•™å¸ˆ]  [TEACHER]  wang@...    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å…¶ä¸­ `[å›­é•¿]` `[ä¸»ä»»]` `[æ•™å¸ˆ]` å°±æ˜¯èŒä½æ ‡ç­¾ã€‚

## å¸¸è§é—®é¢˜

### Q: æˆ‘å·²ç»ä¸ºç”¨æˆ·åˆ†é…äº†èŒä½ï¼Œä½†è¿˜æ˜¯çœ‹ä¸åˆ°
**A**: å°è¯•ä»¥ä¸‹æ“ä½œï¼š
1. ç¡¬åˆ·æ–°é¡µé¢ (Ctrl+F5 æˆ– Cmd+Shift+R)
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
3. é‡æ–°ç™»å½•ç³»ç»Ÿ

### Q: æˆ‘æ²¡æœ‰èŒä½ç®¡ç†é¡µé¢æ€ä¹ˆåŠï¼Ÿ
**A**: ä½¿ç”¨æ–¹æ¡ˆ Cï¼Œé€šè¿‡ API ç›´æ¥åˆ›å»ºèŒä½

### Q: ç³»ç»Ÿä¸­æœ‰å¾ˆå¤šæ•™å¸ˆï¼Œä¸€ä¸ªä¸ªåˆ†é…å¤ªéº»çƒ¦
**A**: å¯ä»¥é€šè¿‡æ•°æ®åº“æ‰¹é‡æ›´æ–°ï¼š
```sql
-- å°†æ‰€æœ‰æ•™å¸ˆçš„èŒä½è®¾ç½®ä¸º"æ•™å¸ˆ"èŒä½
UPDATE "User"
SET "positionId" = 'teacher-position-id'
WHERE role = 'TEACHER' AND "positionId" IS NULL;
```

### Q: æˆ‘æƒ³è®©ä¸åŒçš„æ•™å¸ˆæœ‰ä¸åŒçš„èŒä½æ€ä¹ˆåŠï¼Ÿ
**A**: æŒ‰æ–¹æ¡ˆ A çš„æ­¥éª¤ 2ï¼Œé€ä¸ªä¸ºæ•™å¸ˆåˆ†é…èŒä½

## æŠ€æœ¯è¯´æ˜

### æ•°æ®å…³ç³»
```
User (ç”¨æˆ·/æ•™å¸ˆ)
  â”œâ”€ positionId â†’ Position (èŒä½)
  â”‚                â”œâ”€ name (èŒä½åç§°)
  â”‚                â”œâ”€ type (èŒä½ç±»å‹)
  â”‚                â””â”€ level (èŒä½å±‚çº§)
  â””â”€ role (è§’è‰²: TEACHER/ADMIN/PARENT)
```

### API æŸ¥è¯¢é€»è¾‘
```typescript
// backend/src/modules/approvals/approvals.service.ts
async getApproverOptions() {
  const users = await this.prisma.user.findMany({
    where: {
      isActive: true,
      deletedAt: null,
    },
    select: {
      id: true,
      name: true,
      email: true,
      role: true,
      position: {              // â† å…³è”æŸ¥è¯¢èŒä½
        select: {
          name: true,
          type: true
        }
      }
    }
  });

  return users.map(user => ({
    userId: user.id,
    userName: user.name,
    email: user.email,
    role: user.role,
    position: user.position?.name,      // â† èŒä½åç§°
    positionType: user.position?.type,  // â† èŒä½ç±»å‹
  }));
}
```

## éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœä»¥ä¸Šæ–¹æ¡ˆéƒ½æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´æˆªå›¾
2. Network ä¸­ `/api/approvals/approvers` çš„å®Œæ•´å“åº”
3. æ˜¯å¦æœ‰èŒä½ç®¡ç†é¡µé¢
4. æµ‹è¯•è„šæœ¬çš„è¾“å‡ºç»“æœ

æ›´è¯¦ç»†çš„è°ƒè¯•æ­¥éª¤è¯·æŸ¥çœ‹: **APPROVAL_DEBUG_GUIDE.md**
