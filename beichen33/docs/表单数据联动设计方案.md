# 表单数据联动功能设计方案

## 一、功能概述

### 1.1 核心目标

实现表单系统与学生、教师、班级等核心业务模块的数据联动，包括：
- 表单字段关联系统数据（下拉选择、自动填充）
- 表单提交后数据自动同步到对应模块
- 唯一性校验和智能提示
- 数据冲突处理和关联更新

### 1.2 应用场景

1. **新生入园登记表**：填写学生信息 → 自动创建学生记录
2. **教师入职申请表**：填写教师信息 → 自动创建用户账号
3. **学生信息变更表**：选择学生 → 修改信息 → 同步更新学生记录
4. **班级调整申请表**：选择学生和目标班级 → 审批通过后自动转班

---

## 二、数据库表结构调整

### 2.1 新增 Prisma Schema

```prisma
// ===========================================
// 表单数据联动相关模型
// ===========================================

// 表单模板与实体的关联配置
model FormEntityBinding {
  id          String   @id @default(uuid())
  templateId  String   // 关联的表单模板
  template    FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // 目标实体配置
  entityType  String   // 实体类型：student, user, class
  actionType  String   // 操作类型：create, update, link

  // 字段映射配置（JSON）
  // [{ formField: "studentName", entityField: "name" }, ...]
  fieldMappings Json

  // 触发条件
  triggerOn   String   @default("approved") // approved（审批通过）, submitted（提交时）

  // 唯一性校验字段配置
  // [{ formField: "idCard", entityField: "idCard", errorMessage: "身份证号已存在" }]
  uniqueFields Json?

  // 是否启用
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([templateId])
  @@index([entityType])
}

// 表单提交与实体的关联记录
model FormEntityLink {
  id           String   @id @default(uuid())
  submissionId String   // 表单提交ID
  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  entityType   String   // 实体类型
  entityId     String   // 关联的实体ID
  actionType   String   // 执行的操作：created, updated, linked

  // 操作前后数据快照（用于审计和回滚）
  previousData Json?    // 操作前数据
  newData      Json?    // 操作后数据

  createdAt    DateTime @default(now())

  @@index([submissionId])
  @@index([entityType, entityId])
}
```

### 2.2 修改现有模型

```prisma
// 在 FormTemplate 中添加关联
model FormTemplate {
  // ... 现有字段 ...

  // 新增：实体绑定配置
  entityBindings FormEntityBinding[]
}

// 在 FormSubmission 中添加关联
model FormSubmission {
  // ... 现有字段 ...

  // 新增：实体关联记录
  entityLinks FormEntityLink[]
}

// 在 Student 中添加唯一约束和索引
model Student {
  // ... 现有字段 ...

  // 修改：身份证号添加唯一约束
  idCard      String?   @unique

  // 新增：手机号（家长主要联系人）
  primaryPhone String?

  @@index([idCard])
  @@index([primaryPhone])
}

// 在 User 中确保唯一约束
model User {
  // ... 现有字段 ...

  // 确保唯一约束
  idCard    String?   @unique
  phone     String?   // 考虑添加唯一约束

  @@index([idCard])
  @@index([phone])
}
```

---

## 三、新增字段类型

### 3.1 字段类型扩展

```typescript
// 新增的字段类型定义
const ENTITY_FIELD_TYPES = {
  // 实体选择类型
  'student_select': {
    entityType: 'student',
    displayField: 'name',
    searchFields: ['name', 'idCard'],
    returnFields: ['id', 'name', 'idCard', 'classId', 'className']
  },
  'teacher_select': {
    entityType: 'user',
    filter: { role: 'TEACHER', isActive: true },
    displayField: 'name',
    searchFields: ['name', 'phone', 'idCard'],
    returnFields: ['id', 'name', 'phone', 'positionName']
  },
  'class_select': {
    entityType: 'class',
    displayField: 'name',
    searchFields: ['name'],
    returnFields: ['id', 'name', 'grade', 'teacherNames']
  },
  'campus_select': {
    entityType: 'campus',
    displayField: 'name',
    searchFields: ['name'],
    returnFields: ['id', 'name', 'address']
  },

  // 唯一性校验类型
  'id_card': {
    type: 'text',
    validation: {
      pattern: '^[1-9]\\d{5}(19|20)\\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\\d|3[01])\\d{3}[\\dXx]$',
      message: '请输入正确的身份证号'
    },
    uniqueCheck: {
      entities: ['student', 'user'],
      field: 'idCard'
    }
  },
  'phone': {
    type: 'text',
    validation: {
      pattern: '^1[3-9]\\d{9}$',
      message: '请输入正确的手机号'
    },
    uniqueCheck: {
      entities: ['user'],
      field: 'phone'
    }
  },

  // 自动填充类型
  'auto_fill': {
    // 根据选择的实体自动填充其他字段
    sourceField: 'studentId', // 依赖的字段
    mappings: [
      { from: 'name', to: 'studentName' },
      { from: 'idCard', to: 'studentIdCard' },
      { from: 'class.name', to: 'className' }
    ]
  }
};
```

### 3.2 字段配置示例

```json
{
  "id": "studentId",
  "type": "student_select",
  "label": "选择学生",
  "required": true,
  "placeholder": "请输入学生姓名或身份证号搜索",
  "config": {
    "allowCreate": false,
    "filters": {
      "classId": "${currentUser.classIds}"
    },
    "autoFill": [
      { "from": "name", "to": "studentName" },
      { "from": "idCard", "to": "studentIdCard" },
      { "from": "class.name", "to": "className" }
    ]
  }
}
```

---

## 四、API 接口设计

### 4.1 数据联动查询接口

```typescript
// ================================
// 实体搜索接口
// ================================

/**
 * GET /api/forms/entities/search
 * 统一的实体搜索接口
 */
interface EntitySearchRequest {
  entityType: 'student' | 'user' | 'class' | 'campus';
  keyword?: string;
  filters?: Record<string, any>;
  page?: number;
  limit?: number;
}

interface EntitySearchResponse {
  data: EntityOption[];
  total: number;
}

interface EntityOption {
  id: string;
  label: string;        // 显示文本
  value: string;        // 值（通常是ID）
  extra?: Record<string, any>;  // 附加信息（用于自动填充）
}

// ================================
// 唯一性校验接口
// ================================

/**
 * POST /api/forms/validate/unique
 * 唯一性校验接口
 */
interface UniqueValidateRequest {
  entityType: 'student' | 'user';
  field: string;        // idCard, phone, email
  value: string;
  excludeId?: string;   // 排除当前记录（更新时）
}

interface UniqueValidateResponse {
  isUnique: boolean;
  existingEntity?: {
    id: string;
    name: string;
    [key: string]: any;
  };
  suggestion?: string;  // 提示信息
}

// ================================
// 批量校验接口
// ================================

/**
 * POST /api/forms/validate/batch
 * 批量数据校验（用于导入预检）
 */
interface BatchValidateRequest {
  templateId: string;
  data: Record<string, any>[];
}

interface BatchValidateResponse {
  results: {
    index: number;
    isValid: boolean;
    errors: { field: string; message: string }[];
    warnings: { field: string; message: string }[];
    linkedEntities: { field: string; entityType: string; entityId: string }[];
  }[];
}

// ================================
// 实体绑定配置接口
// ================================

/**
 * POST /api/forms/templates/:id/entity-bindings
 * 配置表单模板的实体绑定
 */
interface EntityBindingRequest {
  entityType: string;
  actionType: 'create' | 'update' | 'link';
  fieldMappings: { formField: string; entityField: string }[];
  triggerOn: 'approved' | 'submitted';
  uniqueFields?: { formField: string; entityField: string; errorMessage: string }[];
}

// ================================
// 数据同步执行接口
// ================================

/**
 * POST /api/forms/submissions/:id/sync-entities
 * 手动触发数据同步（管理员）
 */
interface SyncEntitiesResponse {
  success: boolean;
  results: {
    entityType: string;
    action: string;
    entityId: string;
    status: 'success' | 'failed';
    error?: string;
  }[];
}
```

### 4.2 完整的 API 端点列表

| 方法 | 端点 | 描述 |
|------|------|------|
| GET | `/forms/entities/search` | 统一实体搜索 |
| GET | `/forms/entities/students` | 搜索学生 |
| GET | `/forms/entities/teachers` | 搜索教师 |
| GET | `/forms/entities/classes` | 搜索班级 |
| POST | `/forms/validate/unique` | 唯一性校验 |
| POST | `/forms/validate/batch` | 批量数据校验 |
| GET | `/forms/templates/:id/entity-bindings` | 获取实体绑定配置 |
| POST | `/forms/templates/:id/entity-bindings` | 创建实体绑定 |
| PUT | `/forms/entity-bindings/:id` | 更新实体绑定 |
| DELETE | `/forms/entity-bindings/:id` | 删除实体绑定 |
| POST | `/forms/submissions/:id/sync-entities` | 执行数据同步 |
| GET | `/forms/submissions/:id/entity-links` | 获取关联的实体记录 |

---

## 五、前后端交互逻辑

### 5.1 表单填写时的联动流程

```
用户选择字段类型为 student_select
         ↓
前端发起搜索请求 GET /forms/entities/students?keyword=xxx
         ↓
后端返回匹配的学生列表（带详细信息）
         ↓
用户选择学生
         ↓
前端根据 autoFill 配置自动填充其他字段
         ↓
用户继续填写其他字段
         ↓
前端实时校验唯一性字段 POST /forms/validate/unique
         ↓
显示校验结果和智能提示
```

### 5.2 表单提交时的同步流程

```
用户提交表单
         ↓
后端执行基础校验（必填、格式）
         ↓
后端执行唯一性校验（根据 entityBinding 配置）
         ↓
校验通过 → 创建 FormSubmission 记录
         ↓
检查 triggerOn 配置
         ↓
├─ triggerOn = 'submitted'
│    ↓
│    立即执行数据同步 (syncEntitiesToModules)
│    ↓
│    创建 FormEntityLink 记录
│
└─ triggerOn = 'approved'
     ↓
     启动审批流程
     ↓
     审批通过后执行数据同步
```

### 5.3 数据同步执行逻辑

```typescript
async function syncEntitiesToModules(submissionId: string) {
  const submission = await getSubmission(submissionId);
  const bindings = await getEntityBindings(submission.templateId);

  for (const binding of bindings) {
    const { entityType, actionType, fieldMappings, uniqueFields } = binding;

    // 1. 从表单数据提取实体数据
    const entityData = extractEntityData(submission.data, fieldMappings);

    // 2. 唯一性校验 - 查找已存在的实体
    let existingEntity = null;
    if (uniqueFields) {
      existingEntity = await findExistingEntity(entityType, uniqueFields, entityData);
    }

    // 3. 根据操作类型执行
    let result;
    switch (actionType) {
      case 'create':
        if (existingEntity) {
          // 已存在，根据配置决定：报错 / 更新 / 关联
          result = await handleExistingEntity(existingEntity, entityData, binding);
        } else {
          result = await createEntity(entityType, entityData);
        }
        break;

      case 'update':
        // 必须有关联的实体ID
        const entityId = submission.data[`${entityType}Id`];
        result = await updateEntity(entityType, entityId, entityData);
        break;

      case 'link':
        // 仅关联，不修改数据
        const linkEntityId = submission.data[`${entityType}Id`];
        result = { id: linkEntityId, action: 'linked' };
        break;
    }

    // 4. 记录关联
    await createFormEntityLink({
      submissionId,
      entityType,
      entityId: result.id,
      actionType: result.action,
      previousData: existingEntity,
      newData: entityData
    });
  }
}
```

### 5.4 前端组件交互

```typescript
// 实体选择组件
const EntitySelect: React.FC<{
  fieldConfig: FieldConfig;
  value: string;
  onChange: (value: string, entity: any) => void;
}> = ({ fieldConfig, value, onChange }) => {
  const [options, setOptions] = useState<EntityOption[]>([]);
  const [loading, setLoading] = useState(false);

  // 搜索实体
  const handleSearch = async (keyword: string) => {
    setLoading(true);
    const result = await searchEntities({
      entityType: fieldConfig.config.entityType,
      keyword,
      filters: fieldConfig.config.filters
    });
    setOptions(result.data);
    setLoading(false);
  };

  // 选择实体
  const handleSelect = (selectedValue: string) => {
    const entity = options.find(o => o.value === selectedValue);
    onChange(selectedValue, entity?.extra);

    // 自动填充其他字段
    if (fieldConfig.config.autoFill && entity?.extra) {
      fieldConfig.config.autoFill.forEach(({ from, to }) => {
        const value = getNestedValue(entity.extra, from);
        formInstance.setFieldValue(to, value);
      });
    }
  };

  return (
    <Select
      showSearch
      value={value}
      onSearch={handleSearch}
      onSelect={handleSelect}
      loading={loading}
      options={options}
      filterOption={false}
      notFoundContent={loading ? <Spin size="small" /> : '无匹配数据'}
    />
  );
};

// 唯一性校验字段
const UniqueValidateInput: React.FC<{
  fieldConfig: FieldConfig;
  value: string;
  onChange: (value: string) => void;
}> = ({ fieldConfig, value, onChange }) => {
  const [validating, setValidating] = useState(false);
  const [validateResult, setValidateResult] = useState<UniqueValidateResponse | null>(null);

  // 防抖校验
  const debouncedValidate = useDebouncedCallback(async (val: string) => {
    if (!val) return;

    setValidating(true);
    const result = await validateUnique({
      entityType: fieldConfig.config.uniqueCheck.entities[0],
      field: fieldConfig.config.uniqueCheck.field,
      value: val
    });
    setValidateResult(result);
    setValidating(false);
  }, 500);

  return (
    <div>
      <Input
        value={value}
        onChange={e => {
          onChange(e.target.value);
          debouncedValidate(e.target.value);
        }}
        suffix={validating && <Spin size="small" />}
      />
      {validateResult && !validateResult.isUnique && (
        <Alert
          type="warning"
          message={
            <span>
              该{fieldConfig.label}已存在：
              <a onClick={() => linkExistingEntity(validateResult.existingEntity)}>
                {validateResult.existingEntity.name}
              </a>
              ，是否关联已有记录？
            </span>
          }
        />
      )}
    </div>
  );
};
```

---

## 六、数据验证规则

### 6.1 字段级验证

| 字段类型 | 验证规则 | 错误信息 |
|---------|----------|----------|
| id_card | 正则：18位身份证格式 | 请输入正确的身份证号 |
| phone | 正则：11位手机号 | 请输入正确的手机号 |
| email | 正则：邮箱格式 | 请输入正确的邮箱地址 |
| student_select | 必须是有效的学生ID | 请选择有效的学生 |
| teacher_select | 必须是有效的教师ID | 请选择有效的教师 |
| class_select | 必须是有效的班级ID | 请选择有效的班级 |

### 6.2 业务规则验证

```typescript
const BUSINESS_RULES = {
  // 学生相关
  student: {
    // 身份证号唯一
    idCard: {
      unique: true,
      errorMessage: '该身份证号的学生已存在'
    },
    // 年龄范围
    birthday: {
      validate: (value) => {
        const age = calculateAge(value);
        return age >= 2 && age <= 7;
      },
      errorMessage: '学生年龄应在2-7岁之间'
    },
    // 班级容量检查
    classId: {
      validate: async (value, data) => {
        const classInfo = await getClass(value);
        return classInfo.students.length < classInfo.capacity;
      },
      errorMessage: '该班级已满员'
    }
  },

  // 教师相关
  user: {
    email: {
      unique: true,
      errorMessage: '该邮箱已被注册'
    },
    idCard: {
      unique: true,
      errorMessage: '该身份证号已存在'
    },
    phone: {
      unique: true,
      errorMessage: '该手机号已被使用'
    }
  }
};
```

### 6.3 冲突处理策略

```typescript
enum ConflictStrategy {
  REJECT = 'reject',           // 拒绝，提示错误
  LINK = 'link',               // 关联已有记录
  UPDATE = 'update',           // 更新已有记录
  CREATE_NEW = 'create_new',   // 强制创建新记录
  ASK_USER = 'ask_user'        // 询问用户
}

interface ConflictConfig {
  field: string;
  strategy: ConflictStrategy;
  confirmMessage?: string;  // ASK_USER 时的提示
}
```

---

## 七、扩展场景设计

### 7.1 已有学生查询后修改信息

**场景**：学生信息变更表

```json
{
  "templateConfig": {
    "title": "学生信息变更申请",
    "fields": [
      {
        "id": "studentId",
        "type": "student_select",
        "label": "选择学生",
        "required": true,
        "config": {
          "autoFill": [
            { "from": "name", "to": "currentName" },
            { "from": "idCard", "to": "currentIdCard" },
            { "from": "class.name", "to": "currentClass" },
            { "from": "address", "to": "currentAddress" }
          ]
        }
      },
      { "id": "currentName", "type": "text", "label": "当前姓名", "readonly": true },
      { "id": "currentAddress", "type": "text", "label": "当前地址", "readonly": true },
      { "id": "newName", "type": "text", "label": "新姓名" },
      { "id": "newAddress", "type": "text", "label": "新地址" },
      { "id": "changeReason", "type": "textarea", "label": "变更原因", "required": true }
    ],
    "entityBindings": [{
      "entityType": "student",
      "actionType": "update",
      "triggerOn": "approved",
      "fieldMappings": [
        { "formField": "studentId", "entityField": "id" },
        { "formField": "newName", "entityField": "name", "onlyIfChanged": true },
        { "formField": "newAddress", "entityField": "address", "onlyIfChanged": true }
      ]
    }]
  }
}
```

### 7.2 批量导入

**场景**：批量导入新生信息

```typescript
// 批量导入接口
POST /forms/submissions/batch-import

interface BatchImportRequest {
  templateId: string;
  data: Record<string, any>[];  // Excel 解析后的数据
  options: {
    skipDuplicates: boolean;     // 跳过重复记录
    updateExisting: boolean;     // 更新已存在记录
    dryRun: boolean;             // 预检模式（不实际执行）
  };
}

interface BatchImportResponse {
  total: number;
  success: number;
  failed: number;
  skipped: number;
  results: {
    index: number;
    status: 'success' | 'failed' | 'skipped';
    submissionId?: string;
    entityId?: string;
    errors?: string[];
  }[];
}
```

**批量导入流程**：

```
上传 Excel 文件
      ↓
前端解析为 JSON 数组
      ↓
调用 POST /forms/validate/batch 预检
      ↓
显示预检结果（成功/警告/错误数量）
      ↓
用户确认导入配置（跳过重复/更新已有）
      ↓
调用 POST /forms/submissions/batch-import
      ↓
后端逐条处理：
  ├─ 创建 FormSubmission
  ├─ 执行唯一性校验
  ├─ 根据配置处理冲突
  └─ 同步到对应模块
      ↓
返回导入结果
```

### 7.3 数据冲突处理

**场景**：导入时发现身份证号已存在

```typescript
// 冲突处理选项
interface ConflictResolution {
  type: 'skip' | 'update' | 'create' | 'link';
  message: string;
}

// 冲突检测结果
interface ConflictDetection {
  field: string;
  value: string;
  existingEntity: {
    id: string;
    type: string;
    name: string;
    data: Record<string, any>;
  };
  resolutions: ConflictResolution[];
}
```

**处理策略**：

| 策略 | 说明 | 适用场景 |
|------|------|----------|
| skip | 跳过此记录 | 明确不需要重复数据 |
| update | 更新已有记录 | 数据变更/补充信息 |
| create | 强制创建新记录 | 确认是不同的人（同名不同人） |
| link | 关联已有记录 | 表单关联已存在的实体 |

### 7.4 班级调整/转班

**场景**：学生转班申请

```json
{
  "templateConfig": {
    "title": "学生转班申请",
    "fields": [
      {
        "id": "studentId",
        "type": "student_select",
        "label": "选择学生",
        "required": true,
        "config": {
          "autoFill": [
            { "from": "name", "to": "studentName" },
            { "from": "class.id", "to": "fromClassId" },
            { "from": "class.name", "to": "fromClassName" }
          ]
        }
      },
      { "id": "studentName", "type": "text", "label": "学生姓名", "readonly": true },
      { "id": "fromClassName", "type": "text", "label": "原班级", "readonly": true },
      {
        "id": "toClassId",
        "type": "class_select",
        "label": "目标班级",
        "required": true,
        "config": {
          "excludeClasses": ["${fromClassId}"],
          "showCapacity": true
        }
      },
      { "id": "reason", "type": "textarea", "label": "转班原因", "required": true }
    ],
    "entityBindings": [{
      "entityType": "student",
      "actionType": "update",
      "triggerOn": "approved",
      "fieldMappings": [
        { "formField": "studentId", "entityField": "id" },
        { "formField": "toClassId", "entityField": "classId" }
      ]
    }],
    "approvalConfig": {
      "levels": [
        { "name": "原班主任", "positionType": "TEACHER" },
        { "name": "教务主任", "positionType": "DIRECTOR" }
      ]
    }
  }
}
```

### 7.5 家长信息关联

**场景**：新生入园登记（含家长信息）

```json
{
  "fields": [
    // ... 学生基本信息 ...
    {
      "id": "parentSection",
      "type": "section",
      "label": "家长信息"
    },
    { "id": "parent1Name", "type": "text", "label": "家长1姓名", "required": true },
    { "id": "parent1Phone", "type": "phone", "label": "家长1电话", "required": true },
    { "id": "parent1Relation", "type": "select", "label": "与学生关系", "options": ["父亲", "母亲", "爷爷", "奶奶", "其他"] },
    { "id": "parent2Name", "type": "text", "label": "家长2姓名" },
    { "id": "parent2Phone", "type": "phone", "label": "家长2电话" },
    { "id": "parent2Relation", "type": "select", "label": "与学生关系" }
  ],
  "entityBindings": [
    {
      "entityType": "student",
      "actionType": "create",
      "fieldMappings": [
        { "formField": "studentName", "entityField": "name" },
        { "formField": "studentIdCard", "entityField": "idCard" },
        // ...
      ]
    },
    {
      "entityType": "parent",
      "actionType": "create",
      "condition": "parent1Name != null",
      "fieldMappings": [
        { "formField": "parent1Name", "entityField": "name" },
        { "formField": "parent1Phone", "entityField": "phone" },
        { "formField": "parent1Relation", "entityField": "relation" }
      ],
      "linkToStudent": {
        "studentField": "studentId",
        "isPrimary": true
      }
    }
  ]
}
```

### 7.6 审计和回滚

**功能**：记录所有数据变更，支持回滚

```typescript
// 查看表单关联的实体变更历史
GET /forms/submissions/:id/entity-links

interface EntityLinkDetail {
  id: string;
  entityType: string;
  entityId: string;
  actionType: string;
  previousData: Record<string, any>;
  newData: Record<string, any>;
  createdAt: string;

  // 计算的变更详情
  changes: {
    field: string;
    oldValue: any;
    newValue: any;
  }[];
}

// 回滚实体变更（管理员）
POST /forms/entity-links/:id/rollback

interface RollbackResponse {
  success: boolean;
  restoredData: Record<string, any>;
}
```

---

## 八、默认表单模板示例

### 8.1 新生入园登记表

```typescript
const NEW_STUDENT_ENROLLMENT = {
  title: '新生入园登记表',
  description: '用于登记新入园学生的基本信息，提交后自动创建学生档案',
  isPreset: true,
  presetType: 'student_enrollment',

  fields: [
    // 基本信息
    { id: 'studentName', type: 'text', label: '学生姓名', required: true },
    { id: 'gender', type: 'select', label: '性别', required: true, options: ['男', '女'] },
    { id: 'birthday', type: 'date', label: '出生日期', required: true },
    { id: 'idCard', type: 'id_card', label: '身份证号', required: false },

    // 入园信息
    { id: 'enrollDate', type: 'date', label: '入园日期', required: true },
    { id: 'classId', type: 'class_select', label: '分配班级', required: true },

    // 联系信息
    { id: 'address', type: 'text', label: '家庭住址', required: true },
    { id: 'allergies', type: 'textarea', label: '过敏信息' },

    // 家长信息
    { id: 'parentName', type: 'text', label: '主要联系人', required: true },
    { id: 'parentPhone', type: 'phone', label: '联系电话', required: true },
    { id: 'parentRelation', type: 'select', label: '与学生关系', required: true, options: ['父亲', '母亲', '爷爷', '奶奶', '其他'] }
  ],

  entityBindings: [{
    entityType: 'student',
    actionType: 'create',
    triggerOn: 'approved',
    fieldMappings: [
      { formField: 'studentName', entityField: 'name' },
      { formField: 'gender', entityField: 'gender' },
      { formField: 'birthday', entityField: 'birthday' },
      { formField: 'idCard', entityField: 'idCard' },
      { formField: 'enrollDate', entityField: 'enrollDate' },
      { formField: 'classId', entityField: 'classId' },
      { formField: 'address', entityField: 'address' },
      { formField: 'allergies', entityField: 'allergies' }
    ],
    uniqueFields: [
      { formField: 'idCard', entityField: 'idCard', errorMessage: '该身份证号的学生已存在' }
    ]
  }],

  approvalConfig: {
    levels: [
      { name: '班主任审核', positionType: 'TEACHER' },
      { name: '教务确认', positionType: 'DIRECTOR' }
    ]
  },

  serialNumberConfig: {
    prefix: 'ENROLL',
    dateFormat: 'YYYY',
    digits: 4
  }
};
```

### 8.2 教师入职申请表

```typescript
const TEACHER_ONBOARDING = {
  title: '教师入职申请表',
  description: '用于新教师入职信息登记，审批通过后自动创建教师账号',
  isPreset: true,
  presetType: 'teacher_onboarding',

  fields: [
    // 基本信息
    { id: 'name', type: 'text', label: '姓名', required: true },
    { id: 'gender', type: 'select', label: '性别', required: true, options: ['男', '女'] },
    { id: 'birthday', type: 'date', label: '出生日期', required: true },
    { id: 'idCard', type: 'id_card', label: '身份证号', required: true },

    // 联系方式
    { id: 'phone', type: 'phone', label: '手机号', required: true },
    { id: 'email', type: 'email', label: '邮箱', required: true },

    // 入职信息
    { id: 'hireDate', type: 'date', label: '入职日期', required: true },
    { id: 'positionId', type: 'position_select', label: '职位', required: true },
    { id: 'campusId', type: 'campus_select', label: '所属园区', required: true },

    // 银行信息
    { id: 'bankAccount', type: 'text', label: '银行卡号' },
    { id: 'bankName', type: 'text', label: '开户行' },

    // 其他
    { id: 'education', type: 'text', label: '学历' },
    { id: 'major', type: 'text', label: '专业' }
  ],

  entityBindings: [{
    entityType: 'user',
    actionType: 'create',
    triggerOn: 'approved',
    fieldMappings: [
      { formField: 'name', entityField: 'name' },
      { formField: 'gender', entityField: 'gender' },
      { formField: 'birthday', entityField: 'birthday' },
      { formField: 'idCard', entityField: 'idCard' },
      { formField: 'phone', entityField: 'phone' },
      { formField: 'email', entityField: 'email' },
      { formField: 'hireDate', entityField: 'hireDate' },
      { formField: 'positionId', entityField: 'positionId' },
      { formField: 'campusId', entityField: 'campusId' },
      { formField: 'bankAccount', entityField: 'bankAccount' },
      { formField: 'bankName', entityField: 'bankName' }
    ],
    uniqueFields: [
      { formField: 'email', entityField: 'email', errorMessage: '该邮箱已被注册' },
      { formField: 'idCard', entityField: 'idCard', errorMessage: '该身份证号已存在' },
      { formField: 'phone', entityField: 'phone', errorMessage: '该手机号已被使用' }
    ],
    // 自动设置
    defaultValues: {
      role: 'TEACHER',
      isActive: true,
      employmentStatus: 'PROBATION'
    }
  }],

  approvalConfig: {
    levels: [
      { name: '人事审核', positionType: 'DIRECTOR' },
      { name: '园长审批', positionType: 'PRINCIPAL' }
    ]
  }
};
```

### 8.3 学生信息变更表

```typescript
const STUDENT_INFO_CHANGE = {
  title: '学生信息变更申请',
  description: '用于修改学生档案信息',
  isPreset: true,
  presetType: 'student_info_change',

  fields: [
    {
      id: 'studentId',
      type: 'student_select',
      label: '选择学生',
      required: true,
      config: {
        autoFill: [
          { from: 'name', to: 'currentName' },
          { from: 'idCard', to: 'currentIdCard' },
          { from: 'address', to: 'currentAddress' },
          { from: 'allergies', to: 'currentAllergies' },
          { from: 'class.name', to: 'currentClassName' }
        ]
      }
    },

    // 当前信息（只读）
    { id: 'currentName', type: 'text', label: '当前姓名', readonly: true },
    { id: 'currentIdCard', type: 'text', label: '当前身份证号', readonly: true },
    { id: 'currentAddress', type: 'text', label: '当前地址', readonly: true },
    { id: 'currentAllergies', type: 'text', label: '当前过敏信息', readonly: true },
    { id: 'currentClassName', type: 'text', label: '当前班级', readonly: true },

    // 变更信息
    { id: 'changeType', type: 'checkbox_group', label: '变更项目', required: true,
      options: ['姓名', '身份证号', '地址', '过敏信息'] },
    { id: 'newName', type: 'text', label: '新姓名' },
    { id: 'newIdCard', type: 'id_card', label: '新身份证号' },
    { id: 'newAddress', type: 'text', label: '新地址' },
    { id: 'newAllergies', type: 'textarea', label: '新过敏信息' },

    // 变更原因
    { id: 'reason', type: 'textarea', label: '变更原因', required: true },
    { id: 'attachments', type: 'file', label: '证明材料' }
  ],

  entityBindings: [{
    entityType: 'student',
    actionType: 'update',
    triggerOn: 'approved',
    fieldMappings: [
      { formField: 'studentId', entityField: 'id' },
      { formField: 'newName', entityField: 'name', condition: 'changeType.includes("姓名")' },
      { formField: 'newIdCard', entityField: 'idCard', condition: 'changeType.includes("身份证号")' },
      { formField: 'newAddress', entityField: 'address', condition: 'changeType.includes("地址")' },
      { formField: 'newAllergies', entityField: 'allergies', condition: 'changeType.includes("过敏信息")' }
    ]
  }],

  approvalConfig: {
    levels: [
      { name: '班主任确认', positionType: 'TEACHER' }
    ]
  }
};
```

### 8.4 学生转班申请表

```typescript
const STUDENT_CLASS_TRANSFER = {
  title: '学生转班申请',
  description: '用于学生班级调整',
  isPreset: true,
  presetType: 'class_transfer',

  fields: [
    {
      id: 'studentId',
      type: 'student_select',
      label: '选择学生',
      required: true,
      config: {
        autoFill: [
          { from: 'name', to: 'studentName' },
          { from: 'class.id', to: 'fromClassId' },
          { from: 'class.name', to: 'fromClassName' },
          { from: 'class.grade', to: 'currentGrade' }
        ]
      }
    },
    { id: 'studentName', type: 'text', label: '学生姓名', readonly: true },
    { id: 'fromClassName', type: 'text', label: '原班级', readonly: true },
    { id: 'currentGrade', type: 'text', label: '当前年级', readonly: true },

    {
      id: 'toClassId',
      type: 'class_select',
      label: '目标班级',
      required: true,
      config: {
        showCapacity: true,
        excludeField: 'fromClassId'
      }
    },

    { id: 'reason', type: 'textarea', label: '转班原因', required: true },
    { id: 'effectiveDate', type: 'date', label: '生效日期', required: true }
  ],

  entityBindings: [{
    entityType: 'student',
    actionType: 'update',
    triggerOn: 'approved',
    fieldMappings: [
      { formField: 'studentId', entityField: 'id' },
      { formField: 'toClassId', entityField: 'classId' }
    ]
  }],

  approvalConfig: {
    levels: [
      { name: '原班主任', positionType: 'TEACHER' },
      { name: '新班主任', positionType: 'TEACHER' },
      { name: '教务主任', positionType: 'DIRECTOR' }
    ]
  }
};
```

---

## 九、实现优先级建议

### 第一阶段（核心功能）

1. **数据库表结构更新**
   - 添加 FormEntityBinding 和 FormEntityLink 模型
   - 添加唯一约束

2. **基础 API 实现**
   - 实体搜索接口
   - 唯一性校验接口
   - 数据同步执行逻辑

3. **前端组件开发**
   - EntitySelect 组件（student_select, teacher_select, class_select）
   - 唯一性校验输入组件
   - 自动填充功能

### 第二阶段（完善功能）

4. **预置表单模板**
   - 新生入园登记表
   - 教师入职申请表
   - 学生信息变更表
   - 学生转班申请表

5. **批量导入**
   - 批量校验接口
   - 批量导入接口
   - 冲突处理策略

6. **审计功能**
   - 实体关联记录查询
   - 数据变更历史
   - 回滚功能

### 第三阶段（高级功能）

7. **复杂场景**
   - 家长信息联动
   - 条件字段映射
   - 自定义验证规则

8. **优化和扩展**
   - 性能优化（缓存、批量处理）
   - 更多实体类型支持
   - 导出功能

---

## 十、技术实现注意事项

1. **事务处理**：数据同步操作应使用数据库事务，确保原子性

2. **性能优化**：
   - 实体搜索接口添加缓存
   - 批量操作使用事务批处理
   - 自动填充数据在前端缓存

3. **安全考虑**：
   - 校验用户权限（只能查询/操作本园区数据）
   - 敏感字段脱敏（身份证号、手机号）
   - 操作日志记录

4. **错误处理**：
   - 同步失败时不影响表单提交
   - 提供手动重试机制
   - 详细的错误信息

5. **向后兼容**：
   - 新功能不影响现有表单
   - 渐进式启用数据联动
