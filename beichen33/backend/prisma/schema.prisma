generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  TEACHER
  PARENT
}

enum RecordType {
  LEARNING
  LIFE
  HEALTH
  BEHAVIOR
  ARTWORK
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PurchasePlanStatus {
  DRAFT      // 草稿
  CONFIRMED  // 已确认
  ORDERED    // 已下单
  COMPLETED  // 已完成
}

enum PositionType {
  PRINCIPAL
  VICE_PRINCIPAL
  DIRECTOR
  FINANCE
  TEACHER
  NURSERY_TEACHER
  LOGISTICS
  FRONTLINE
  OTHER
}

enum EmploymentStatus {
  ACTIVE
  RESIGNED
  PROBATION
  SUSPENDED
}

model Campus {
  id          String    @id @default(uuid())
  name        String
  address     String?
  phone       String?
  principalId String?
  principal   User?     @relation("CampusPrincipal", fields: [principalId], references: [id])

  users       User[]    @relation("CampusUsers")
  students    Student[]
  classes     Class[]
  dailyObservations DailyObservation[] @relation("DailyObservationCampus")
  dutyReports DutyReport[] @relation("DutyReportCampus")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([name])
  @@index([principalId])
}

model Position {
  id          String       @id @default(uuid())
  name        String
  type        PositionType
  level       Int
  parentId    String?
  parent      Position?    @relation("PositionHierarchy", fields: [parentId], references: [id])
  children    Position[]   @relation("PositionHierarchy")
  description String?

  users       User[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?

  @@index([type])
  @@index([level])
  @@index([parentId])
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  name      String
  phone     String?
  idCard    String?   // 身份证号，可用于登录（暂不设唯一约束，避免迁移冲突）
  role      UserRole
  avatar    String?
  isActive  Boolean   @default(true)
  gender    String?
  birthday  DateTime?
  hireDate  DateTime?
  resignationDate DateTime?

  // 银行信息
  bankAccount String?   // 银行卡号
  bankName    String?   // 开户行详细信息
  workplace   String?   @default("北辰幼儿园") // 工作单位

  campusId  String
  campus    Campus    @relation("CampusUsers", fields: [campusId], references: [id])

  positionId String?
  position   Position? @relation(fields: [positionId], references: [id])

  employmentStatus EmploymentStatus @default(ACTIVE)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  classes         Class[]        @relation("ClassTeachers")
  growthRecords   GrowthRecord[]
  formSubmissions FormSubmission[]
  principalOfCampus Campus[]     @relation("CampusPrincipal")
  purchasePlans   PurchasePlan[]
  dailyObservations DailyObservation[] @relation("DailyObservationTeacher")
  dutyReports       DutyReport[]       @relation("DutyReportLeader")
  approvalTasks     ApprovalTask[]
  transferredTasks  ApprovalTask[]     @relation("TransferredTasks")
  attendanceRecords AttendanceRecord[] @relation("AttendanceRecordCreator")
  studentAttendances Attendance[]

  @@index([email])
  @@index([role])
  @@index([campusId])
  @@index([positionId])
  @@index([employmentStatus])
  @@index([idCard])
}

model Student {
  id          String    @id @default(uuid())
  name        String
  idCard      String?   @unique  // 身份证号唯一
  gender      String
  birthday    DateTime
  enrollDate  DateTime
  avatar      String?
  allergies   String?
  address     String?

  // 采购计划相关字段
  ageGroup    String?   // 年龄段：2-3/3-4/4-5/5-6/6-7
  birthDate   DateTime? // 出生日期（用于自动计算年龄段）

  // 主要联系人手机号（便于表单联动校验）
  primaryPhone String?

  campusId    String
  campus      Campus    @relation(fields: [campusId], references: [id])

  classId     String
  class       Class     @relation(fields: [classId], references: [id])

  parents     StudentParent[]
  growthRecords GrowthRecord[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([classId])
  @@index([name])
  @@index([campusId])
  @@index([ageGroup])
  @@index([idCard])
  @@index([primaryPhone])
}

model Parent {
  id          String    @id @default(uuid())
  name        String
  phone       String
  email       String?
  relation    String

  students    StudentParent[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([phone])
}

model StudentParent {
  studentId   String
  parentId    String
  isPrimary   Boolean   @default(false)

  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parent      Parent    @relation(fields: [parentId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now())

  @@id([studentId, parentId])
}

model Class {
  id          String    @id @default(uuid())
  name        String
  grade       String
  capacity    Int       @default(30)
  campusId    String?
  campus      Campus?   @relation(fields: [campusId], references: [id])

  teachers    User[]    @relation("ClassTeachers")
  students    Student[]
  dailyObservations DailyObservation[] @relation("DailyObservationClass")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([grade])
  @@index([campusId])
}

model GrowthRecord {
  id          String      @id @default(uuid())
  studentId   String
  student     Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  type        RecordType
  category    String?
  title       String
  content     String
  images      String[]
  tags        String[]

  height      Float?
  weight      Float?

  recordedBy  String
  teacher     User        @relation(fields: [recordedBy], references: [id])
  recordedAt  DateTime    @default(now())

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  deletedAt   DateTime?

  @@index([studentId, recordedAt])
  @@index([type])
  @@index([recordedAt])
}

model Ingredient {
  id          String    @id @default(uuid())
  name        String
  unit        String
  protein     Float     @default(0)
  fat         Float     @default(0)
  carbs       Float     @default(0)
  calories    Float     @default(0)
  fiber       Float     @default(0)
  vitaminA    Float     @default(0)
  vitaminB1   Float     @default(0)
  vitaminB2   Float     @default(0)
  vitaminC    Float     @default(0)
  calcium     Float     @default(0)
  iron        Float     @default(0)
  zinc        Float     @default(0)
  sodium      Float     @default(0)
  cost        Float     @default(0)

  // 采购计划相关字段
  supplierCategory String?  // 供应商类别
  conversionRate   Float?   // 换算率（如：1斤=500克）

  dishIngredients DishIngredient[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([name])
  @@index([supplierCategory])
}

model Dish {
  id          String    @id @default(uuid())
  name        String
  category    String
  description String?
  price       Float     @default(0)

  ingredients DishIngredient[]
  menuItems   MenuItem[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([name])
  @@index([category])
}

model DishIngredient {
  id          String    @id @default(uuid())
  dishId      String
  dish        Dish      @relation(fields: [dishId], references: [id], onDelete: Cascade)

  ingredientId String
  ingredient  Ingredient @relation(fields: [ingredientId], references: [id])

  amount      Float     @default(100)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([dishId])
  @@index([ingredientId])
}

model Menu {
  id          String    @id @default(uuid())
  name        String
  startDate   DateTime
  endDate     DateTime
  grade       String?
  teacherId   String?

  menuItems   MenuItem[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([startDate])
  @@index([endDate])
  @@index([grade])
  @@index([teacherId])
}

model MenuItem {
  id          String    @id @default(uuid())
  menuId      String
  menu        Menu      @relation(fields: [menuId], references: [id], onDelete: Cascade)

  dishId      String
  dish        Dish      @relation(fields: [dishId], references: [id])

  day         String
  mealType    String

  createdAt   DateTime  @default(now())

  @@index([menuId])
  @@index([dishId])
}

model FormTemplate {
  id          String    @id @default(uuid())
  title       String
  description String?

  // 主表字段配置
  fields      Json      // 主表字段数组

  // 明细表配置（支持主从表）
  detailTableConfig Json?  // { enabled: boolean, columns: [...], calculations: [...] }

  // 计算规则配置
  calculations Json?    // [{ field: "total", formula: "price * quantity" }, { field: "grandTotal", formula: "SUM(details.total)" }]

  // 流水号配置
  serialNumberConfig Json? // { prefix: "REPAIR", dateFormat: "YYYY", digits: 3 }

  // 是否为预置模板
  isPreset    Boolean   @default(false)
  presetType  String?   // "repair_approval", "purchase_approval" 等

  // 分享token（用于匿名填写）
  shareToken  String?   @unique

  isActive    Boolean   @default(true)

  submissions FormSubmission[]

  // 实体绑定配置
  entityBindings FormEntityBinding[]

  // 关联的审批流程
  approvalFlows ApprovalFlow[]

  // ==================== 业务数据映射配置 ====================

  // 主要业务类型（该表单主要操作哪种业务数据）
  primaryBusinessType String?  // student, teacher, class, parent

  // 操作类型
  businessActionType  String?  // create, update, link

  // 字段映射配置
  // [{ formField: "studentName", businessField: "name", businessType: "student" }]
  fieldMappings Json?

  // 唯一性校验配置
  // [{ formField: "idCard", businessField: "idCard", businessType: "student", errorMessage: "已存在" }]
  uniqueValidations Json?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([title])
  @@index([isPreset])
  @@index([presetType])
  @@index([shareToken])
  @@index([primaryBusinessType])
}

model FormSubmission {
  id          String    @id @default(uuid())
  templateId  String
  template    FormTemplate @relation(fields: [templateId], references: [id])

  // 流水号
  serialNumber String?   // REPAIR-2024-001

  submittedBy String
  user        User      @relation(fields: [submittedBy], references: [id])

  // 主表数据
  data        Json

  // 明细表数据（主从表）
  detailData  Json?     // [{ id: 1, date: "2024-01-01", location: "教室", price: 100, quantity: 2, total: 200 }, ...]

  // 计算结果
  calculatedValues Json? // { grandTotal: 1500, itemCount: 5 }

  // 审批流程信息
  approvalFlowId String?
  approvalFlow   ApprovalFlow? @relation(fields: [approvalFlowId], references: [id])

  // 审批状态
  approvalStatus ApprovalSubmissionStatus @default(DRAFT)

  // 当前审批节点序号
  currentNodeSequence Int @default(0) // 0表示未开始审批，1开始第一级

  // 审批任务
  approvalTasks ApprovalTask[]

  // ==================== 业务数据同步相关 ====================

  // 是否已同步到业务数据
  syncedToBusinessData Boolean @default(false)

  // 同步时间
  syncedAt DateTime?

  // 业务数据关联记录
  businessDataLinks BusinessDataLink[]

  // 旧的实体关联记录（保留兼容）
  entityLinks FormEntityLink[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([templateId])
  @@index([submittedBy])
  @@index([approvalStatus])
  @@index([approvalFlowId])
  @@index([serialNumber])
  @@index([syncedToBusinessData])
}

// ==================== 审批流程模型（新架构） ====================

// 审批流程模板
model ApprovalFlow {
  id          String    @id @default(uuid())
  name        String    // 流程名称
  description String?   // 流程描述

  // 关联的表单模板（可选）
  formTemplateId String?
  formTemplate   FormTemplate? @relation(fields: [formTemplateId], references: [id])

  isActive    Boolean   @default(true)

  // 流程节点
  nodes       ApprovalNode[]

  // 使用此流程的提交记录
  submissions FormSubmission[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([formTemplateId])
  @@index([isActive])
}

// 审批节点
model ApprovalNode {
  id          String    @id @default(uuid())
  flowId      String
  flow        ApprovalFlow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  name        String    // 节点名称
  sequence    Int       // 节点顺序

  // 审批类型
  type        ApprovalNodeType  // SERIAL(串行) | PARALLEL(并行)

  // 并行审批模式
  parallelMode ParallelMode?    // AND(会签) | OR(或签)

  // 审批人配置 [{ userId: "xxx", userName: "张三" }]
  approvers   Json

  // 审批人类型
  approverType String   @default("user")  // user(指定用户), role(角色), position(职位), superior(上级)

  // 审批权限
  canReject   Boolean   @default(true)
  canReturn   Boolean   @default(true)
  canTransfer Boolean   @default(false)

  // 驳回行为
  rejectBehavior String @default("END")  // END(结束流程), RETURN_TO_START(退回发起人), RETURN_TO_PREVIOUS(退回上一节点)

  // 超时设置（小时）
  timeoutHours Int?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([flowId])
  @@index([sequence])
}

enum ApprovalNodeType {
  SERIAL      // 串行
  PARALLEL    // 并行
}

enum ParallelMode {
  AND  // 会签：全部通过
  OR   // 或签：任意通过
}

// 审批任务
model ApprovalTask {
  id            String    @id @default(uuid())

  // 关联的提交记录
  submissionId  String
  submission    FormSubmission @relation(fields: [submissionId], references: [id])

  // 流程节点信息
  flowId        String
  nodeId        String
  nodeName      String
  nodeSequence  Int

  // 审批人信息
  approverId    String
  approver      User      @relation(fields: [approverId], references: [id])

  // 任务状态
  status        ApprovalTaskStatus  @default(PENDING)

  // 审批结果
  action        ApprovalAction?
  comment       String?

  // 转交信息
  transferredTo String?
  transferredToUser User? @relation("TransferredTasks", fields: [transferredTo], references: [id])

  // 时间信息
  assignedAt    DateTime  @default(now())
  completedAt   DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([submissionId])
  @@index([approverId, status])
  @@index([status])
  @@index([assignedAt])
}

enum ApprovalTaskStatus {
  PENDING     // 待审批
  APPROVED    // 已通过
  REJECTED    // 已驳回
  RETURNED    // 已退回
  TRANSFERRED // 已转交
  CANCELLED   // 已取消
}

enum ApprovalAction {
  APPROVE   // 通过
  REJECT    // 驳回
  RETURN    // 退回
  TRANSFER  // 转交
}

enum ApprovalSubmissionStatus {
  DRAFT       // 草稿
  PENDING     // 审批中
  APPROVED    // 已通过
  REJECTED    // 已驳回
  RETURNED    // 已退回
  CANCELLED   // 已撤回
}

// 表单模板与实体的绑定配置
model FormEntityBinding {
  id          String   @id @default(uuid())
  templateId  String
  template    FormTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // 目标实体配置
  entityType  String   // student, user, class, parent
  actionType  String   // create, update, link

  // 字段映射配置（JSON）
  // [{ formField: "studentName", entityField: "name" }, ...]
  fieldMappings Json

  // 触发条件
  triggerOn   String   @default("approved") // approved, submitted

  // 唯一性校验字段配置
  // [{ formField: "idCard", entityField: "idCard", errorMessage: "身份证号已存在" }]
  uniqueFields Json?

  // 默认值配置（创建时自动设置的字段）
  defaultValues Json?

  // 条件配置（满足条件才执行）
  condition   String?

  // 是否启用
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([templateId])
  @@index([entityType])
}

// 表单提交与实体的关联记录（旧模型，保留兼容）
model FormEntityLink {
  id           String   @id @default(uuid())
  submissionId String
  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  entityType   String   // student, user, class, parent
  entityId     String   // 关联的实体ID
  actionType   String   // created, updated, linked

  // 操作前后数据快照（用于审计和回滚）
  previousData Json?
  newData      Json?

  createdAt    DateTime @default(now())

  @@index([submissionId])
  @@index([entityType, entityId])
}

// 业务数据关联记录（新模型）
model BusinessDataLink {
  id           String   @id @default(uuid())

  // 关联的表单提交
  submissionId String
  submission   FormSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // 业务数据类型和ID
  businessType String   // student, teacher, class, parent
  businessId   String   // 对应业务表的ID

  // 操作类型
  actionType   String   // created（新建）, updated（更新）, linked（关联）

  // 字段映射快照（用于追溯）
  fieldMappings Json?

  // 同步前的数据快照（用于回滚）
  previousData Json?

  // 同步后的数据
  newData      Json?

  // 同步状态
  syncStatus   SyncStatus @default(SUCCESS)

  // 错误信息（如果同步失败）
  errorMessage String?

  createdAt    DateTime @default(now())

  @@index([submissionId])
  @@index([businessType, businessId])
  @@index([syncStatus])
}

enum SyncStatus {
  SUCCESS     // 同步成功
  FAILED      // 同步失败
  ROLLED_BACK // 已回滚
}

model ReportTemplate {
  id          String    @id @default(uuid())
  name        String
  description String?
  query       String
  template    String

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  @@index([name])
}

// 幼儿营养标准（按年龄段）
model NutritionStandard {
  id          String   @id @default(uuid())
  ageGroup    String   @unique // 年龄段：2-3/3-4/4-5/5-6/6-7
  ageLabel    String   // 显示标签：2-3岁/3-4岁等

  // 每日营养摄入标准（单位：克或毫升）
  caloriesMin Float    // 最低热量 (kcal)
  caloriesMax Float    // 最高热量 (kcal)
  proteinMin  Float    // 蛋白质 (g)
  proteinMax  Float
  fatMin      Float    // 脂肪 (g)
  fatMax      Float
  carbsMin    Float    // 碳水化合物 (g)
  carbsMax    Float

  // 三餐分配比例
  breakfastRatio Float  @default(0.25)  // 早餐 25%
  lunchRatio     Float  @default(0.40)  // 中餐 40%
  snackRatio     Float  @default(0.15)  // 午点 15%
  dinnerRatio    Float  @default(0.20)  // 晚餐 20%

  // 食材用量参考（单位：克/人/餐）
  grainPerMeal     Float  @default(50)   // 主食类（米面）
  vegetablePerMeal Float  @default(100)  // 蔬菜类
  meatPerMeal      Float  @default(50)   // 肉类
  eggPerMeal       Float  @default(30)   // 蛋类
  milkPerDay       Float  @default(250)  // 奶类（每日）

  description String?  // 备注说明
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ageGroup])
}

// 采购计划
model PurchasePlan {
  id          String   @id @default(uuid())
  name        String   // 计划名称，如"2024年11月10日-14日采购计划"
  startDate   DateTime // 开始日期
  endDate     DateTime // 结束日期

  menuId      String?  // 关联的菜单ID（可选）

  // 学生统计信息（JSON）
  studentStats Json    // { "2-3": 15, "3-4": 20, "4-5": 25, ... }

  // 计算结果（JSON）
  purchaseItems Json   // 采购清单详细数据
  dailyPurchaseItems Json? // 每日采购明细数据

  status      PurchasePlanStatus @default(DRAFT)

  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  creator     User     @relation(fields: [createdBy], references: [id])
  printRecords PrintToken[] @relation("PurchasePlanPrint")

  @@index([startDate, endDate])
  @@index([createdBy])
  @@index([status])
}

// 供应商管理
model Supplier {
  id            String   @id @default(uuid())
  name          String   // 供应商名称
  category      String   // 类别：粮油/猪肉/牛肉/蔬菜/调料/面条/鸡蛋/鸡肉/水果/糕点/牛奶/海鲜
  contactPerson String?  // 联系人
  contactPhone  String?  // 电话
  address       String?  // 地址
  notes         String?  // 备注
  isActive      Boolean  @default(true)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([category])
  @@index([name])
}

// 打印令牌（用于公开访问打印页面）
model PrintToken {
  id          String   @id @default(uuid())
  token       String   @unique // 唯一令牌
  entityType  String   // 实体类型：purchase_plan/menu等
  entityId    String   // 实体ID

  expiresAt   DateTime // 过期时间
  createdAt   DateTime @default(now())

  purchasePlan PurchasePlan? @relation("PurchasePlanPrint", fields: [entityId], references: [id])

  @@index([token])
  @@index([entityType, entityId])
  @@index([expiresAt])
}

// 每日观察记录
model DailyObservation {
  id                String   @id @default(uuid())
  date              DateTime // 日期
  weather           String   // 天气
  teacherId         String   // 老师ID
  classId           String   // 班级ID
  campusId          String?  // 园区ID

  // 时间日志
  timeline          Json?    // [{time: "07:00", event: "入园"}]

  // 观察要点
  lifeActivity      String?  @db.Text // 生活活动
  outdoorActivity   String?  @db.Text // 户外运动
  learningActivity  String?  @db.Text // 学习活动
  gameActivity      String?  @db.Text // 游戏活动
  wonderfulMoment   String?  @db.Text // 精彩瞬间
  homeCooperation   String?  @db.Text // 家园共育

  teacher           User     @relation("DailyObservationTeacher", fields: [teacherId], references: [id])
  class             Class    @relation("DailyObservationClass", fields: [classId], references: [id])
  campus            Campus?  @relation("DailyObservationCampus", fields: [campusId], references: [id])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([date])
  @@index([teacherId])
  @@index([classId])
  @@index([campusId])
}

// 值班播报记录
model DutyReport {
  id                String   @id @default(uuid())
  date              DateTime // 日期
  weather           String   // 天气
  dutyLeader        String   // 值班领导姓名（冗余存储）
  dutyLeaderId      String?  // 值班领导ID（关联教师）
  campusId          String?  // 园区ID

  // 各项记录
  attendance        String?  @db.Text // 出勤情况
  entryExit         String?  @db.Text // 入园离园
  learningActivity  String?  @db.Text // 学习活动
  areaActivity      String?  @db.Text // 区域活动
  outdoorActivity   String?  @db.Text // 户外活动
  lifeActivity      String?  @db.Text // 生活活动
  notice            String?  @db.Text // 温馨提示
  safety            String?  @db.Text // 校园安全
  other             String?  @db.Text // 其他事项

  campus            Campus?  @relation("DutyReportCampus", fields: [campusId], references: [id])
  dutyLeaderUser    User?    @relation("DutyReportLeader", fields: [dutyLeaderId], references: [id])

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([date])
  @@index([campusId])
  @@index([dutyLeaderId])
}

// ==================== 移动端相关模型 ====================

// 考勤状态枚举
enum AttendanceStatus {
  PRESENT   // 到校
  ABSENT    // 缺勤
  LATE      // 迟到
  LEAVE     // 请假
}

// 考勤记录批次（一次点名）
model AttendanceRecord {
  id          String   @id @default(uuid())
  date        DateTime // 考勤日期
  classId     String   // 班级ID

  createdBy   String   // 创建人（教师）
  creator     User     @relation("AttendanceRecordCreator", fields: [createdBy], references: [id])

  attendances Attendance[] // 该批次的所有考勤记录

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date, classId])
  @@index([createdBy])
}

// 学生考勤记录
model Attendance {
  id        String   @id @default(uuid())

  recordId  String   // 考勤批次ID
  record    AttendanceRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)

  studentId String   // 学生ID
  status    AttendanceStatus @default(PRESENT) // 考勤状态
  note      String?  // 备注

  createdBy String   // 记录人（教师）
  creator   User     @relation(fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recordId])
  @@index([studentId])
  @@index([status])
}

// 公告
model Announcement {
  id          String   @id @default(uuid())
  title       String   // 标题
  content     String   @db.Text // 内容
  type        String   @default("general") // 类型：general/urgent/event
  priority    Int      @default(0) // 优先级（数字越大越靠前）

  campusId    String?  // 园区ID（为空表示全校公告）
  classIds    String[] // 目标班级ID列表（为空表示全校）

  publishedAt DateTime? // 发布时间
  expiredAt   DateTime? // 过期时间

  isActive    Boolean  @default(true) // 是否生效

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([publishedAt])
  @@index([campusId])
  @@index([type])
  @@index([isActive])
}
