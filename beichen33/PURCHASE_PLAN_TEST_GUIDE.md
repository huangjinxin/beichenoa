# 采购计划管理功能 - 测试指南

## 🎉 功能概述

成功实现了完整的**采购计划管理系统**，包括：

1. **幼儿营养标准配置** - 支持5个年龄段的营养标准管理
2. **智能采购计划生成** - 根据菜单、学生数量和年龄分布自动计算
3. **采购计划管理** - 完整的计划生命周期管理（草稿→确认→下单→完成）
4. **打印功能** - 支持导出打印采购清单

---

## 📋 测试步骤

### 第一步：启动服务

```bash
# 1. 启动后端服务（如果未运行）
cd backend
docker-compose up -d

# 2. 启动前端服务（如果未运行）
cd frontend
npm run dev
```

### 第二步：登录系统

1. 访问 http://localhost:5173
2. 使用管理员账号登录（如果没有账号，需要先创建）

### 第三步：配置营养标准

1. 进入 **食堂管理 → 营养标准配置**
2. 点击 **"应用推荐标准"** 按钮，系统将自动创建5个年龄段的营养标准：
   - 2-3岁
   - 3-4岁
   - 4-5岁
   - 5-6岁
   - 6-7岁
3. 查看推荐标准表格，确认数据已加载
4. （可选）点击"编辑"按钮自定义某个年龄段的标准

### 第四步：准备基础数据

在生成采购计划前，需要确保系统中有以下数据：

**1. 学生数据**
- 进入 **人员管理 → 学生管理**
- 确保学生数据中包含 `birthday`（生日）或 `ageGroup`（年龄段）字段
- 如果没有，可以编辑现有学生，添加生日信息
- 系统会自动根据生日计算年龄段

**2. 食材数据**
- 进入 **食堂管理 → 食材管理**
- 为食材添加 `supplierCategory`（供应商类别），如：
  - 粮油
  - 蔬菜
  - 猪肉
  - 鸡蛋
  - 牛奶
  - 等

**3. 菜品数据**
- 进入 **食堂管理 → 菜品管理**
- 创建菜品并关联食材
- 设置每个食材的用量（克）

**4. 菜单数据**
- 进入 **食堂管理 → 食谱管理**
- 创建一周菜谱，选择菜品

### 第五步：生成采购计划

1. 进入 **食堂管理 → 采购计划管理**
2. 点击 **"生成采购计划"** 按钮
3. 填写表单：
   - **日期范围**：选择采购计划的起止日期（如：2025-01-13 至 2025-01-17）
   - **选择菜单**：选择该日期范围内的菜谱
   - **适用班级**：选择要统计的班级
4. 查看 **"学生统计预览"**，确认：
   - 总人数正确
   - 年龄分布正确
5. 点击 **"生成采购计划"** 按钮

### 第六步：查看采购计划详情

生成成功后会自动跳转到详情页，可以看到：

1. **基本信息**：
   - 计划名称
   - 日期范围
   - 状态
   - 创建人

2. **学生统计**：
   - 总人数
   - 各年龄段人数分布

3. **采购清单表格**：
   - 所有食材按供应商分类显示
   - 显示食材名称和采购数量（已转换为"斤"）

4. **按供应商分类卡片**：
   - 每个供应商的食材清单
   - 便于采购员按供应商下单

### 第七步：测试打印功能

1. 在采购计划详情页
2. 点击 **"打印采购计划"** 按钮
3. 浏览器会打开打印预览
4. 确认打印格式：
   - 标题：北辰幼儿园采购计划
   - 日期范围
   - 学生统计
   - 采购清单表格
   - 按供应商分类
   - 签字栏（采购员签字、日期）

### 第八步：测试状态流转

1. 返回 **采购计划管理** 列表页
2. 测试状态流转：
   - 草稿状态：点击"确认"按钮 → 状态变为"已确认"
   - 已确认状态：点击"下单"按钮 → 状态变为"已下单"
   - 已下单状态：点击"完成"按钮 → 状态变为"已完成"

---

## 🧪 核心功能测试用例

### 测试用例1：年龄段系数计算

**目的**：验证系统是否根据年龄段应用不同的用量系数

**步骤**：
1. 创建两个班级：
   - 小班（2-3岁）10人
   - 大班（6-7岁）10人
2. 创建相同的菜单
3. 分别为两个班级生成采购计划
4. 对比采购量

**预期结果**：
- 小班采购量应该约为基准的 0.8 倍（系数0.8）
- 大班采购量应该约为基准的 1.2 倍（系数1.2）

### 测试用例2：单位换算

**目的**：验证系统是否正确将克转换为斤

**步骤**：
1. 创建食材：米饭，单位"克"
2. 创建菜品：白米饭，使用100克米饭
3. 创建菜单：早餐白米饭
4. 为10人生成采购计划

**预期结果**：
- 采购清单显示：米饭 2斤（1000克 ÷ 500 = 2斤）

### 测试用例3：食材汇总

**目的**：验证系统是否正确汇总相同食材

**步骤**：
1. 创建多个菜品都使用"鸡蛋"
2. 创建菜单包含这些菜品
3. 生成采购计划

**预期结果**：
- 采购清单中鸡蛋只出现一次
- 数量为所有菜品用量之和

### 测试用例4：供应商分类

**目的**：验证系统是否正确按供应商分类

**步骤**：
1. 为食材设置不同的供应商类别（蔬菜、肉类、粮油等）
2. 生成采购计划

**预期结果**：
- 采购清单按供应商分类显示
- 每个供应商的食材单独列出

---

## 🔧 API 测试（Postman/cURL）

### 1. 应用推荐营养标准

```bash
curl -X POST http://localhost:8891/api/canteen/nutrition/standards/apply-recommended \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json"
```

### 2. 获取营养标准

```bash
curl -X GET http://localhost:8891/api/canteen/nutrition/standards \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 生成采购计划

```bash
curl -X POST http://localhost:8891/api/canteen/purchase/generate \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "startDate": "2025-01-13",
    "endDate": "2025-01-17",
    "menuIds": ["menu_id_1"],
    "classIds": ["class_id_1", "class_id_2"]
  }'
```

### 4. 获取学生统计

```bash
curl -X GET "http://localhost:8891/api/students/stats?classIds=class_id_1,class_id_2" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## 📊 数据示例

### 营养标准示例（4-5岁）

```json
{
  "ageGroup": "4-5",
  "ageLabel": "4-5岁",
  "caloriesMin": 1500,
  "caloriesMax": 1700,
  "proteinMin": 45,
  "proteinMax": 55,
  "fatMin": 50,
  "fatMax": 60,
  "carbsMin": 180,
  "carbsMax": 210,
  "grainPerMeal": 60,
  "vegetablePerMeal": 120,
  "meatPerMeal": 60,
  "eggPerMeal": 35,
  "milkPerDay": 300,
  "description": "4-5岁幼儿每日营养推荐摄入量"
}
```

### 采购计划示例

```json
{
  "id": "plan_123",
  "name": "2025-01-13至2025-01-17采购计划",
  "startDate": "2025-01-13",
  "endDate": "2025-01-17",
  "studentStats": {
    "2-3": 5,
    "3-4": 10,
    "4-5": 15,
    "5-6": 12,
    "6-7": 8
  },
  "purchaseItems": {
    "蔬菜": [
      { "name": "白菜", "amount": 10, "unit": "斤" },
      { "name": "西红柿", "amount": 8, "unit": "斤" }
    ],
    "肉类": [
      { "name": "猪肉", "amount": 15, "unit": "斤" }
    ],
    "鸡蛋": [
      { "name": "鸡蛋", "amount": 20, "unit": "斤" }
    ]
  },
  "status": "DRAFT"
}
```

---

## ❗ 常见问题

### Q1: 生成采购计划时提示"No students found"

**原因**：选择的班级中没有学生，或学生数据缺少年龄信息

**解决**：
1. 确保班级中有学生
2. 为学生添加生日（birthday）或年龄段（ageGroup）字段

### Q2: 采购清单数量为0

**原因**：菜品的食材用量未设置

**解决**：
1. 检查菜品管理中的食材用量（amount字段）
2. 确保用量大于0

### Q3: 营养标准无法应用

**原因**：数据库连接问题或Prisma Client未更新

**解决**：
```bash
cd backend
npx prisma generate
docker restart beichen33-backend-1
```

### Q4: 前端页面显示404

**原因**：路由配置未生效或前端未重新编译

**解决**：
```bash
cd frontend
# 重启开发服务器
npm run dev
```

---

## ✅ 验收标准

完成测试后，确认以下功能正常：

- [ ] 营养标准配置页面可以访问
- [ ] "应用推荐标准"按钮可以成功创建5个年龄段的标准
- [ ] 采购计划生成页面可以访问
- [ ] 选择菜单和班级后可以看到学生统计预览
- [ ] 可以成功生成采购计划
- [ ] 采购计划详情页正确显示所有信息
- [ ] 采购清单按供应商正确分类
- [ ] 打印功能正常，格式符合要求
- [ ] 状态流转功能正常（草稿→确认→下单→完成）
- [ ] 采购计划列表页正确显示所有计划

---

## 📞 技术支持

如有问题，请检查：

1. **后端日志**：
```bash
docker logs beichen33-backend-1
```

2. **数据库状态**：
```bash
docker ps | grep postgres
```

3. **前端控制台**：打开浏览器开发者工具查看错误信息

---

## 🎊 功能亮点

1. **智能计算**：
   - 自动根据年龄段应用不同的用量系数
   - 自动汇总相同食材
   - 自动单位换算（克→斤）

2. **人性化设计**：
   - 实时显示学生统计预览
   - 按供应商分类便于采购
   - 打印格式专业规范

3. **完整流程**：
   - 支持完整的采购计划生命周期管理
   - 状态流转清晰
   - 操作权限控制

4. **数据准确**：
   - 基于《中国居民膳食营养素参考摄入量》
   - 符合幼儿园实际需求
   - 计算逻辑严谨

---

祝测试顺利！🎉
